


<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="A collection of hands-on Builder Sesssions to learn about using Secrets Manager.">
      
      
        <link rel="canonical" href="https://secrets-manager.awssecworkshops.com/RDSFargate/RDS/">
      
      
        <meta name="author" content="aws-security-workshops@amazon.com">
      
      <link rel="shortcut icon" href="../../assets/images/aws-favicon.ico">
      <meta name="generator" content="mkdocs-1.1.2, mkdocs-material-5.5.6">
    
    
      
        <title>RDS phase - Secrets Manager Builder Sessions</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.63b94e9e.min.css">
      
      
    
    
    
      
        <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback">
        <style>body,input{font-family:"Roboto",-apple-system,BlinkMacSystemFont,Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono",SFMono-Regular,Consolas,Menlo,monospace}</style>
      
    
    
    
      <link rel="stylesheet" href="../../stylesheets/custom.css">
    
    
      
    
    
  </head>
  
  
    <body dir="ltr">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#using-aws-secrets-manager-with-amazon-rds-and-aws-fargate-rds-phase" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid" aria-label="Header">
    <a href="https://secrets-manager.awssecworkshops.com/" title="Secrets Manager Builder Sessions" class="md-header-nav__button md-logo" aria-label="Secrets Manager Builder Sessions">
      
  <img src="../../assets/images/aws_smile_logo.png" alt="logo">

    </a>
    <label class="md-header-nav__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg>
    </label>
    <div class="md-header-nav__title" data-md-component="header-title">
      
        <div class="md-header-nav__ellipsis">
          <span class="md-header-nav__topic md-ellipsis">
            Secrets Manager Builder Sessions
          </span>
          <span class="md-header-nav__topic md-ellipsis">
            
              RDS phase
            
          </span>
        </div>
      
    </div>
    
      <label class="md-header-nav__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0116 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 019.5 16 6.5 6.5 0 013 9.5 6.5 6.5 0 019.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
      </label>
      
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" data-md-state="active">
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0116 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 019.5 16 6.5 6.5 0 013 9.5 6.5 6.5 0 019.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </label>
      <button type="reset" class="md-search__icon md-icon" aria-label="Clear" data-md-component="search-reset" tabindex="-1">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg>
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header-nav__source">
        
<a href="https://github.com/aws-samples/aws-secretsmgr-workshop/" title="Go to repository" class="md-source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05L244 40.45a28.87 28.87 0 00-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 01-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 000 40.81l195.61 195.6a28.86 28.86 0 0040.8 0l194.69-194.69a28.86 28.86 0 000-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    aws-samples/aws-secretsmgr-workshop
  </div>
</a>
      </div>
    
  </nav>
</header>
    
    <div class="md-container" data-md-component="container">
      
        
      
      
        
          

  

<nav class="md-tabs md-tabs--active" aria-label="Tabs" data-md-component="tabs">
  <div class="md-tabs__inner md-grid">
    <ul class="md-tabs__list">
      
        
  <li class="md-tabs__item">
    
      <a href="../.." class="md-tabs__link">
        Overview
      </a>
    
  </li>

      
        
  
  
    <li class="md-tabs__item">
      
        <a href="../" class="md-tabs__link md-tabs__link--active">
          RDS and Fargate
        </a>
      
    </li>
  

      
        
      
        
      
    </ul>
  </div>
</nav>
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="https://secrets-manager.awssecworkshops.com/" title="Secrets Manager Builder Sessions" class="md-nav__button md-logo" aria-label="Secrets Manager Builder Sessions">
      
  <img src="../../assets/images/aws_smile_logo.png" alt="logo">

    </a>
    Secrets Manager Builder Sessions
  </label>
  
    <div class="md-nav__source">
      
<a href="https://github.com/aws-samples/aws-secretsmgr-workshop/" title="Go to repository" class="md-source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05L244 40.45a28.87 28.87 0 00-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 01-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 000 40.81l195.61 195.6a28.86 28.86 0 0040.8 0l194.69-194.69a28.86 28.86 0 000-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    aws-samples/aws-secretsmgr-workshop
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href="../.." title="Overview" class="md-nav__link">
      Overview
    </a>
  </li>

    
      
      
      

  


  <li class="md-nav__item md-nav__item--active md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-2" type="checkbox" id="nav-2" checked>
    
    <label class="md-nav__link" for="nav-2">
      RDS and Fargate
      <span class="md-nav__icon md-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M8.59 16.58L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"/></svg>
      </span>
    </label>
    <nav class="md-nav" aria-label="RDS and Fargate" data-md-level="1">
      <label class="md-nav__title" for="nav-2">
        <span class="md-nav__icon md-icon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
        </span>
        RDS and Fargate
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../" title="Scenario" class="md-nav__link">
      Scenario
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../build/" title="Build phase" class="md-nav__link">
      Build phase
    </a>
  </li>

        
          
          
          

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
    
      
    
    
      <label class="md-nav__link md-nav__link--active" for="__toc">
        RDS phase
        <span class="md-nav__icon md-icon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 9h14V7H3v2m0 4h14v-2H3v2m0 4h14v-2H3v2m16 0h2v-2h-2v2m0-10v2h2V7h-2m0 6h2v-2h-2v2z"/></svg>
        </span>
      </label>
    
    <a href="./" title="RDS phase" class="md-nav__link md-nav__link--active">
      RDS phase
    </a>
    
      
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#overview" class="md-nav__link">
    Overview
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#view-the-cloudformation-stack" class="md-nav__link">
    View the CloudFormation stack
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#store-the-secret" class="md-nav__link">
    Store the secret
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#access-the-database" class="md-nav__link">
    Access the database
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#rotate-the-secret" class="md-nav__link">
    Rotate the secret
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#access-the-database_1" class="md-nav__link">
    Access the database
  </a>
  
</li>
      
    </ul>
  
</nav>
    
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../Fargate/" title="Fargate phase" class="md-nav__link">
      Fargate phase
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../cleanup/" title="Clean up phase" class="md-nav__link">
      Clean up phase
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../contribute/" title="Contributing" class="md-nav__link">
      Contributing
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="https://github.com/aws-samples/aws-secretsmgr-workshop/blob/master/LICENSE" title="License" class="md-nav__link">
      License
    </a>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#overview" class="md-nav__link">
    Overview
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#view-the-cloudformation-stack" class="md-nav__link">
    View the CloudFormation stack
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#store-the-secret" class="md-nav__link">
    Store the secret
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#access-the-database" class="md-nav__link">
    Access the database
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#rotate-the-secret" class="md-nav__link">
    Rotate the secret
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#access-the-database_1" class="md-nav__link">
    Access the database
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                  <a href="https://github.com/aws-samples/aws-secretsmgr-workshop/edit/master/docs/RDSFargate/RDS.md" title="Edit this page" class="md-content__button md-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25z"/></svg>
                  </a>
                
                
                  
                
                
                <!--                                                                                       -->

<!-- Copyright 2018 Amazon.com, Inc. or its affiliates. All Rights Reserved.               -->

<!--                                                                                       -->

<!-- Permission is hereby granted, free of charge, to any person obtaining a copy of this  -->

<!-- software and associated documentation files (the "Software"), to deal in the Software -->

<!-- without restriction, including without limitation the rights to use, copy, modify,    -->

<!-- merge, publish, distribute, sublicense, and/or sell copies of the Software, and to    -->

<!-- permit persons to whom the Software is furnished to do so.                            -->

<!--                                                                                       -->

<!-- THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR IMPLIED,   -->

<!-- INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY, FITNESS FOR A         -->

<!-- PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT    -->

<!-- HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION     -->

<!-- OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE        -->

<!-- SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.                                -->

<!--                                                                                       -->

<h1 id="using-aws-secrets-manager-with-amazon-rds-and-aws-fargate-rds-phase">Using AWS Secrets Manager with Amazon RDS and AWS Fargate - RDS Phase</h1>
<h2 id="overview">Overview</h2>
<p>In this phase, you will learn how to use AWS Secrets Manager for rotating the password for a private Amazon RDS database. As a reminder, the environment provisioned by CloudFormation is shown in the figure below.   You will not be working with the AWS Fargate container in this phase so it is not shown below.</p>
<p><img alt="Workshop Architecture" src="../images/RDSPhase.png" /></p>
<table>
<thead>
<tr>
<th><strong>Important</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td>For the sake of simplicity, this tutorial uses jq to parse the secret value into environment variables to allow for easy command line manipulation. This is NOT a security best practice for a production environment. In a production environment, we recommend that you don't store passwords in environment variables.  Click <strong><a href="https://docs.aws.amazon.com/secretsmanager/latest/userguide/best-practices.html" target="_blank">here</a></strong> to read about the best practices for using Secrets Manager.</td>
</tr>
</tbody>
</table>
<h2 id="view-the-cloudformation-stack">View the CloudFormation stack</h2>
<ol>
<li>
<p>Go to the <strong><a href="https://console.aws.amazon.com/cloudformation" target="_blank">CloudFormation console</a></strong> and identify the stack that you built.  Make sure you are in the correct region.  The list of stacks will look similar to the figure below.  The appearance may vary based on the version of the console you are using.  The red arrow points to a link with the name of the CloudFormation stack.  If your stack was built by the AWS Event Engine, it will have a name that starts with <em>mod-</em> rather than the example below which uses <em>smdemo</em>.</p>
<p><img alt="Stack List" src="../images/RDSFargateStackList.png" /></p>
</li>
<li>
<p>Click the stack name link to reveal more information about the stack as shown in the figure below.</p>
<p><img alt="Stack List" src="../images/RDSFargateSingleStack.png" /></p>
</li>
<li>
<p>Click the Outputs tab as shown in the figure above to list the outputs of the stack which will be similar to the figure below.</p>
<p><img alt="CloudFormation Outputs" src="../images/RDSStackOutputs.png" /></p>
<p>The meanings of the output values are described in the table below.</p>
<table>
<thead>
<tr>
<th>Key</th>
<th>Meaning of Value</th>
</tr>
</thead>
<tbody>
<tr>
<td>BastionIP</td>
<td>The IP address of the bastion host</td>
</tr>
<tr>
<td>DBInstance</td>
<td>The Amazon RDS instance id</td>
</tr>
<tr>
<td>DBPassword</td>
<td>The master password of the RDS data base</td>
</tr>
<tr>
<td>DBUser</td>
<td>The master user of the RDS data base</td>
</tr>
<tr>
<td>EC2UserPassword</td>
<td>The password for the ec2-user id</td>
</tr>
<tr>
<td>ECRRepository</td>
<td>The ECR repository id</td>
</tr>
<tr>
<td>ECSCluster</td>
<td>The ECS cluster id</td>
</tr>
</tbody>
</table>
<p>You will need the values in the DBInstance, DBPassword, DBUser, and EC2UserPassword outputs in the next section so copy them to a file on your desktop so they are readily available.</p>
</li>
</ol>
<h2 id="store-the-secret">Store the secret</h2>
<p>In this section, you will store the RDS database credentials in AWS Secrets Manager.</p>
<ol>
<li>
<p>Go to the <strong><a href="https://console.aws.amazon.com/secretsmanager" target="_blank">Secrets Manager console</a></strong>.</p>
</li>
<li>
<p>Check your region to make sure the Secrets Manager console is operating in the correct region. If not, then switch your region into the region in which you deployed your CloudFomration stack.</p>
</li>
<li>
<p>Click <strong>Store a new secret</strong>.</p>
</li>
<li>
<p>Select the <strong>Credentials for RDS database</strong> radio button.</p>
</li>
<li>
<p>Copy the values for the DBUser and DBPassword CloudFormation output values that you got from the CloudFormation stack into the <strong>User name</strong> and <strong>Password</strong> fields respectively.</p>
</li>
<li>
<p>For the encryption key, Secrets Manager gives you the option of using the default KMS key that Secrets Manager creates for your account.  This default key is managed by Secrets Manager itself.  It provides encryption but you do not have the ability manage the policies or grants for the key.  You can also specify your own KMS key which gives you more the option of configuring grants and policies that provide more granular permissions.</p>
<p>In a production environment that requires fine-grained security controls, you would likely choose your own key.  For this workshop we do not require these additional controls so select <strong>DefaultEncryptionKey</strong> in the dropdown menu.</p>
</li>
<li>
<p>Scroll down to the bottom of the page and you will see a list of your RDS instances.  Select the RDS instance based on the DBInstance CloudFormation output value.</p>
<p><img alt="AWS Secrets Manager store secret part 1" src="../images/RDSSMStore1.png" /></p>
</li>
<li>
<p>Click <strong>Next</strong>.</p>
</li>
<li>
<p>Enter a name for the secret.  You can pick a name or just use <strong>smdemo</strong> as shown below.  Note that this must bot be the name of a secret that is pending deletion.</p>
<p><img alt="AWS Secrets Manager store secret part 2" src="../images/RDSSMStore2.png" /></p>
</li>
<li>
<p>Click <strong>Next</strong>.</p>
</li>
<li>
<p>Select <strong>Disable automatic rotation</strong> and then click <strong>Next</strong>.   We will enable rotation later in this module.</p>
<p><img alt="AWS Secrets Manager store secret part 3" src="../images/RDSSMStore3.png" /></p>
</li>
<li>
<p>Click <strong>Store</strong>.</p>
<p>You have now stored your secret value as shown below.</p>
<p><img alt="AWS Secrets Manager store secret part 4" src="../images/RDSSMStore4.png" /></p>
</li>
</ol>
<h2 id="access-the-database">Access the database</h2>
<p>In this section, you will connect to the bastion host so you can run scripts that the CloudFormation template has created on the instance.  Complete all the steps below unless they are marked "optional."</p>
<ol>
<li>
<p>Connect to the bastion host using AWS Systems Manager Session Manager.  To do this:</p>
<ol>
<li>Go to the <strong><a href="https://console.aws.amazon.com/systems-manager" target="_blank">Systems Manager console</a></strong>.</li>
<li>Click <strong>Session Manager</strong>.</li>
<li>Click <strong>Start session</strong>.</li>
<li>Select the radio button for the instance associated with the bastion host.</li>
<li>Click <strong>Start session</strong>.</li>
</ol>
</li>
<li>
<p>The scripts you will be using are owned by the ec2-user account.  Enter the command below to change your effective user id and directory to those of ec2-user:</p>
<div class="codehilite"><pre><span></span><code><span class="err">sudo su - ec2-user</span>
</code></pre></div>


</li>
<li>
<p>Display the current directory using this command:</p>
<div class="codehilite"><pre><span></span><code><span class="err">ls</span>
</code></pre></div>


<p>You will see two shell scripts.</p>
<ul>
<li>
<p>mysql.oldway.sh - This shell script connects to the database the "old" way, using a hard-coded password.</p>
</li>
<li>
<p>mysql.newway.sh - This shell script connects to the database the "new" way, using AWS Secrets Manager.</p>
</li>
</ul>
</li>
<li>
<p>View the file mysql.oldway.sh using this command:</p>
<div class="codehilite"><pre><span></span><code><span class="err">cat mysql.oldway.sh</span>
</code></pre></div>


<p>You will see contents similar to the lines below.  The values PASSWORD, USER, and ENDPOINT represent the hard-coded database password, username, and host endpoint.</p>
<div class="codehilite"><pre><span></span><code><span class="p">(</span><span class="n">Note</span><span class="p">:</span> <span class="n">This</span> <span class="n">code</span> <span class="n">fragment</span> <span class="k">is</span> <span class="k">for</span> <span class="n">illustration</span> <span class="k">only</span> <span class="k">and</span> <span class="k">not</span> <span class="n">intended</span> <span class="k">for</span> <span class="n">copying</span><span class="p">.)</span>

<span class="o">#/</span><span class="n">bin</span><span class="o">/</span><span class="n">bash</span>

<span class="o">#</span> <span class="n">mysql</span><span class="p">.</span><span class="n">oldway</span><span class="p">.</span><span class="n">sh</span>

<span class="o">#</span> <span class="n">This</span> <span class="k">is</span> <span class="n">the</span> <span class="k">old</span> <span class="n">way</span> <span class="k">of</span> <span class="n">accessing</span> <span class="n">a</span> <span class="k">database</span><span class="p">,</span> <span class="k">with</span> <span class="n">a</span> <span class="n">hard</span><span class="o">-</span><span class="n">coded</span> <span class="n">password</span><span class="p">.</span>
<span class="o">#</span> <span class="n">This</span> <span class="n">script</span> <span class="n">will</span> <span class="k">only</span> <span class="k">work</span> <span class="k">right</span> <span class="k">after</span> <span class="n">the</span> <span class="n">CloudFormation</span> <span class="k">template</span> <span class="n">runs</span><span class="p">.</span>
<span class="o">#</span> <span class="k">After</span> <span class="n">you</span> <span class="n">store</span> <span class="k">and</span> <span class="n">rotate</span> <span class="n">the</span> <span class="n">secret</span><span class="p">,</span> <span class="n">you</span> <span class="n">will</span> <span class="n">need</span> <span class="k">to</span> <span class="n">use</span> <span class="n">the</span>
<span class="o">#</span> <span class="n">mysql</span><span class="p">.</span><span class="n">newway</span><span class="p">.</span><span class="n">sh</span> <span class="n">script</span><span class="p">.</span>

<span class="n">mysql</span> <span class="err">\</span>
<span class="o">-</span><span class="n">pPASSWORD</span> <span class="err">\</span>
<span class="o">-</span><span class="n">u</span> <span class="k">USER</span> <span class="err">\</span>
<span class="o">-</span><span class="n">P</span> <span class="mi">3306</span> <span class="err">\</span>
<span class="o">-</span><span class="n">h</span> <span class="n">ENDPOINT</span>
</code></pre></div>


</li>
<li>
<p>Test the script mysql.oldway.sh using the commands shown below.  The first command invokes the script.  The subsequent commands select the database, display the table names in the database, query the rows in the table, and exit MySQL.  Note that MySQL commands end with a semicolon (";").</p>
<div class="codehilite"><pre><span></span><code><span class="err">./mysql.oldway.sh</span>
<span class="err">use smdemo;</span>
<span class="err">show tables;</span>
<span class="err">select * from bookinfo;</span>
<span class="err">quit;</span>
</code></pre></div>


<p>You can see an example of the output below.  This shows that you can access the database, the "old" way, with a hard-coded user name and password. You may be wondering why MariaDB appears in the image below.  Amazon Linux 2 includes the MariaDB port of the <strong>mysql</strong> command as an "extras" module.  The <strong>mysql</strong> program is compatible with both MySQL and MariaDB.</p>
<p><img alt="AWS Secrets Manager old way before rotation" src="../images/RDSMSQLoldpre.png" /></p>
</li>
<li>
<p>View the file mysql.newway.sh by entering this command:</p>
<div class="codehilite"><pre><span></span><code><span class="err">cat mysql.newway.sh</span>
</code></pre></div>


<p>Take a look at the lines below.</p>
<div class="codehilite"><pre><span></span><code><span class="p">(</span><span class="n">Note</span><span class="p">:</span> <span class="n">This</span> <span class="n">code</span> <span class="n">fragment</span> <span class="k">is</span> <span class="k">for</span> <span class="n">illustration</span> <span class="k">and</span> <span class="k">not</span> <span class="n">intended</span> <span class="k">for</span> <span class="n">copying</span><span class="p">.)</span>

<span class="n">getsecretvalue</span><span class="p">()</span> <span class="err">{</span>
  <span class="n">aws</span> <span class="n">secretsmanager</span> <span class="k">get</span><span class="o">-</span><span class="n">secret</span><span class="o">-</span><span class="n">value</span> <span class="c1">--secret-id $1 | \</span>
    <span class="n">jq</span> <span class="p">.</span><span class="n">SecretString</span> <span class="o">|</span> <span class="err">\</span>
    <span class="n">jq</span> <span class="n">fromjson</span>
<span class="err">}</span>
</code></pre></div>


<p>The above lines define a shell function that uses the AWS CLI to retrieve the secret whose name is passed as a command line argument ($1). The result is a JSON string so the <em>jq</em> utility is used to extract the actual value of the secret whose JSON key is named <em>SecretString</em>.  Here is an example of what a <em>SecretString</em> looks like:</p>
<div class="codehilite"><pre><span></span><code><span class="p">(</span><span class="n">Note</span><span class="p">:</span> <span class="n">This</span> <span class="n">code</span> <span class="n">fragment</span> <span class="k">is</span> <span class="k">for</span> <span class="n">illustration</span> <span class="k">and</span> <span class="k">not</span> <span class="n">intended</span> <span class="k">for</span> <span class="n">copying</span><span class="p">.)</span>

<span class="err">{</span>
  <span class="ss">&quot;engine&quot;</span><span class="p">:</span> <span class="ss">&quot;mysql&quot;</span><span class="p">,</span>
  <span class="ss">&quot;username&quot;</span><span class="p">:</span> <span class="ss">&quot;myuser&quot;</span><span class="p">,</span>
  <span class="ss">&quot;password&quot;</span><span class="p">:</span> <span class="ss">&quot;mypassword&quot;</span><span class="p">,</span>
  <span class="ss">&quot;host&quot;</span><span class="p">:</span> <span class="ss">&quot;my-database-endpoint.us-east-1.rds.amazonaws.com&quot;</span><span class="p">,</span>
  <span class="ss">&quot;dbname&quot;</span><span class="p">:</span> <span class="ss">&quot;myDatabase&quot;</span><span class="p">,</span>
  <span class="ss">&quot;port&quot;</span><span class="p">:</span> <span class="ss">&quot;3306&quot;</span>
<span class="err">}</span>
</code></pre></div>


<p>Note that the <em>SecretString</em> itself is a JSON structure.  Now look at the following lines.</p>
<div class="codehilite"><pre><span></span><code><span class="p">(</span><span class="n">Note</span><span class="p">:</span> <span class="n">This</span> <span class="n">code</span> <span class="n">fragment</span> <span class="k">is</span> <span class="k">for</span> <span class="n">illustration</span> <span class="k">and</span> <span class="k">not</span> <span class="n">intended</span> <span class="k">for</span> <span class="n">copying</span><span class="p">.)</span>

<span class="n">secret</span><span class="o">=`</span><span class="n">getsecretvalue</span> <span class="err">$</span><span class="mi">1</span><span class="o">`</span>
<span class="k">user</span><span class="o">=</span><span class="err">$</span><span class="p">(</span><span class="n">echo</span> <span class="err">$</span><span class="n">secret</span> <span class="o">|</span> <span class="n">jq</span> <span class="o">-</span><span class="n">r</span> <span class="p">.</span><span class="n">username</span><span class="p">)</span>
<span class="n">password</span><span class="o">=</span><span class="err">$</span><span class="p">(</span><span class="n">echo</span> <span class="err">$</span><span class="n">secret</span> <span class="o">|</span> <span class="n">jq</span> <span class="o">-</span><span class="n">r</span> <span class="p">.</span><span class="n">password</span><span class="p">)</span>
<span class="n">endpoint</span><span class="o">=</span><span class="err">$</span><span class="p">(</span><span class="n">echo</span> <span class="err">$</span><span class="n">secret</span> <span class="o">|</span> <span class="n">jq</span> <span class="o">-</span><span class="n">r</span> <span class="p">.</span><span class="k">host</span><span class="p">)</span>
<span class="n">port</span><span class="o">=</span><span class="err">$</span><span class="p">(</span><span class="n">echo</span> <span class="err">$</span><span class="n">secret</span> <span class="o">|</span> <span class="n">jq</span> <span class="o">-</span><span class="n">r</span> <span class="p">.</span><span class="n">port</span><span class="p">)</span>
</code></pre></div>


<p>These lines call the shell function and then use <em>jq</em> to extract the database username, password, endpoint, and port from the <em>SecretString</em>.  These are then passed to the <em>mysql</em> command as shown on the lines below.  Note that there is no space after the -p option.</p>
<div class="codehilite"><pre><span></span><code><span class="p">(</span><span class="n">Note</span><span class="p">:</span> <span class="n">This</span> <span class="n">code</span> <span class="n">fragment</span> <span class="k">is</span> <span class="k">for</span> <span class="n">illustration</span> <span class="k">and</span> <span class="k">not</span> <span class="n">intended</span> <span class="k">for</span> <span class="n">copying</span><span class="p">.)</span>

<span class="n">mysql</span> <span class="err">\</span>
<span class="o">-</span><span class="n">p$password</span> <span class="err">\</span>
<span class="o">-</span><span class="n">u</span> <span class="err">$</span><span class="k">user</span> <span class="err">\</span>
<span class="o">-</span><span class="n">P</span> <span class="err">$</span><span class="n">port</span> <span class="err">\</span>
<span class="o">-</span><span class="n">h</span> <span class="err">$</span><span class="n">endpoint</span>
</code></pre></div>


</li>
<li>
<p>Run the mysql.newway.sh script by running the commands below.  The first command invokes the script.  <strong>Note that you must specify the name of the secret!</strong> In this example, the secret's name is <em>smdemo</em>. The subsequent commands select the database, display the table names in the database, query the rows in the table, and exit MySQL.</p>
<div class="codehilite"><pre><span></span><code><span class="err">./mysql.newway.sh smdemo</span>
<span class="err">use smdemo;</span>
<span class="err">show tables;</span>
<span class="err">select * from bookinfo;</span>
<span class="err">quit;</span>
</code></pre></div>


<p>You can see an example of the output below.  This shows that you can access the database, the "new" way, using AWS Secrets Manager.</p>
<p><img alt="AWS Secrets Manager new way before rotation" src="../images/RDSMSQLnewpre.png" /></p>
</li>
</ol>
<h2 id="rotate-the-secret">Rotate the secret</h2>
<p>In this section, you will enable the rotation of the secret you created in AWS Secrets Manager.</p>
<ol>
<li>
<p>Go to the <strong><a href="https://console.aws.amazon.com/secretsmanager" target="_blank">Secrets Manager console</a></strong>.</p>
</li>
<li>
<p>Check your region to make sure the Secrets Manager console is operating in the correct region. If not, then switch your region into the region in which you deployed your CloudFomration stack.</p>
</li>
<li>
<p>Click on the secret that you previously created.</p>
</li>
<li>
<p>Click <strong>Edit rotation</strong>.</p>
</li>
<li>
<p>Select <strong>Enable automatic rotation</strong>.</p>
</li>
<li>
<p>Choose <strong>30 days</strong> for the rotation interval.  </p>
</li>
<li>
<p>Select the <strong>Create a new Lambda function to perform rotation</strong> radio button.  This will cause Secrets Manager to use CloudFormation on your behalf to create a rotation function using the AWS Serverless Application Repository.   If you had customized your own rotation function or if you were using a credential for a special application, you would select that here.</p>
</li>
<li>
<p>Enter a name for the rotation function.   In the figure below, we used <strong>smdemo</strong> but you can select whatever you wish.</p>
</li>
<li>
<p>You now need to select the secret whose permissions will be used to rotate the secret.  For this Builder Session, select <strong>Use this secret.</strong>  This will tell the rotation function to access the RDS database using the secret and rotate <em>the same secret</em>.</p>
<p>If your application supports two classes of users, for example a "superuser" and a "normal privilege" user, you could select <strong>Use a secret that I have previously stored in Secrets Manager</strong> and use the "superuser" credential to rotate the credential for the "normal privilege" user.</p>
<p>Your window should look similar to the figure below.</p>
<p><img alt="AWS Secrets Manager rotation part 1" src="../images/RDSRotate1.png" /></p>
</li>
<li>
<p>Click <strong>Save</strong>.</p>
</li>
<li>
<p>You will see a message telling you that the rotation is beginning and that you should remain on the page until it is complete. AWS Secrets Manager is now using the <a href="https://aws.amazon.com/serverless/serverlessrepo/">AWS Serverless Application Repository</a> to install an <a href="https://aws.amazon.com/lambda/">AWS Lambda rotation</a> function on your behalf.  <strong>Do not leave this page until the rotation is complete.</strong></p>
<p><img alt="AWS Secrets Manager rotation part 2" src="../images/RDSRotate2.png" /></p>
<p>A message will appear when the rotation is complete.  <strong>Refresh your browser window to update your any cached fields.</strong></p>
<p><img alt="AWS Secrets Manager rotation part 3" src="../images/RDSRotate3.png" /></p>
</li>
<li>
<p>Click <strong>Retrieve secret value</strong> to see the new password value.</p>
</li>
</ol>
<h2 id="access-the-database_1">Access the database</h2>
<p>Let's try to connect to the database again, both the "old" way with a hard-coded password, the "new" way with AWS Secrets Manager.</p>
<ol>
<li>
<p>On the bastion host, run the command below to access the database using the hard-coded password.</p>
<div class="codehilite"><pre><span></span><code><span class="err">./mysql.oldway.sh</span>
</code></pre></div>


<p>You should receive an error message (access denied) because the mysql.oldway.sh script has the same hard-coded password.</p>
<p><img alt="AWS Secrets Manager old way after rotation" src="../images/RDSMSQLoldpost.png" /></p>
</li>
<li>
<p>Run the commands below to access the database with Secrets Manager by running the commands below.  <strong>Note that you must specify the name of the secret!</strong> In this example, the secret's name is <em>smdemo</em>.  You should be able to access the database as you did before because Secrets Manager fetches the new credential rather than using a hard-coded credential.</p>
<div class="codehilite"><pre><span></span><code><span class="err">./mysql.newway.sh smdemo</span>
<span class="err">use smdemo;</span>
<span class="err">show tables;</span>
<span class="err">select * from bookinfo;</span>
<span class="err">quit;</span>
</code></pre></div>


</li>
</ol>
<p>You have completed ths RDS phase and have learned how to use AWS Secrets Manager with Amazon RDS.  You will now continue to the Fargate phase. </p>
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid" aria-label="Footer">
        
          <a href="../build/" title="Build phase" class="md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-footer-nav__button md-icon">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
            </div>
            <div class="md-footer-nav__title">
              <div class="md-ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                Build phase
              </div>
            </div>
          </a>
        
        
          <a href="../Fargate/" title="Fargate phase" class="md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-footer-nav__title">
              <div class="md-ellipsis">
                <span class="md-footer-nav__direction">
                  Next
                </span>
                Fargate phase
              </div>
            </div>
            <div class="md-footer-nav__button md-icon">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4z"/></svg>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
          <div class="md-footer-copyright__highlight">
            <a href="https://aws.amazon.com/privacy/" target="_blank">Privacy</a> | <a href="https://aws.amazon.com/terms/" target="_blank">Site terms</a> | &copy; 2020, Amazon Web Services, Inc. or its affiliates. All rights reserved.
          </div>
        
        Made with
        <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
          Material for MkDocs
        </a>
      </div>
      
  <div class="md-footer-social">
    
      
      
        
        
      
      <a href="https://awssecworkshops.com" target="_blank" rel="noopener" title="awssecworkshops.com" class="md-footer-social__link">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512"><path d="M280.37 148.26L96 300.11V464a16 16 0 0016 16l112.06-.29a16 16 0 0015.92-16V368a16 16 0 0116-16h64a16 16 0 0116 16v95.64a16 16 0 0016 16.05L464 480a16 16 0 0016-16V300L295.67 148.26a12.19 12.19 0 00-15.3 0zM571.6 251.47L488 182.56V44.05a12 12 0 00-12-12h-56a12 12 0 00-12 12v72.61L318.47 43a48 48 0 00-61 0L4.34 251.47a12 12 0 00-1.6 16.9l25.5 31A12 12 0 0045.15 301l235.22-193.74a12.19 12.19 0 0115.3 0L530.9 301a12 12 0 0016.9-1.6l25.5-31a12 12 0 00-1.7-16.93z"/></svg>
      </a>
    
      
      
        
        
      
      <a href="https://aws.amazon.com/security/" target="_blank" rel="noopener" title="aws.amazon.com" class="md-footer-social__link">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M466.5 83.7l-192-80a48.15 48.15 0 00-36.9 0l-192 80C27.7 91.1 16 108.6 16 128c0 198.5 114.5 335.7 221.5 380.3 11.8 4.9 25.1 4.9 36.9 0C360.1 472.6 496 349.3 496 128c0-19.4-11.7-36.9-29.5-44.3zM256.1 446.3l-.1-381 175.9 73.3c-3.3 151.4-82.1 261.1-175.8 307.7z"/></svg>
      </a>
    
      
      
        
        
      
      <a href="https://twitter.com/awssecurityinfo?lang=en" target="_blank" rel="noopener" title="twitter.com" class="md-footer-social__link">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M459.37 151.716c.325 4.548.325 9.097.325 13.645 0 138.72-105.583 298.558-298.558 298.558-59.452 0-114.68-17.219-161.137-47.106 8.447.974 16.568 1.299 25.34 1.299 49.055 0 94.213-16.568 130.274-44.832-46.132-.975-84.792-31.188-98.112-72.772 6.498.974 12.995 1.624 19.818 1.624 9.421 0 18.843-1.3 27.614-3.573-48.081-9.747-84.143-51.98-84.143-102.985v-1.299c13.969 7.797 30.214 12.67 47.431 13.319-28.264-18.843-46.781-51.005-46.781-87.391 0-19.492 5.197-37.36 14.294-52.954 51.655 63.675 129.3 105.258 216.365 109.807-1.624-7.797-2.599-15.918-2.599-24.04 0-57.828 46.782-104.934 104.934-104.934 30.213 0 57.502 12.67 76.67 33.137 23.715-4.548 46.456-13.32 66.599-25.34-7.798 24.366-24.366 44.833-46.132 57.827 21.117-2.273 41.584-8.122 60.426-16.243-14.292 20.791-32.161 39.308-52.628 54.253z"/></svg>
      </a>
    
      
      
        
        
      
      <a href="https://aws.amazon.com/blogs/security/" target="_blank" rel="noopener" title="aws.amazon.com" class="md-footer-social__link">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M400 32H48C21.49 32 0 53.49 0 80v352c0 26.51 21.49 48 48 48h352c26.51 0 48-21.49 48-48V80c0-26.51-21.49-48-48-48zM112 416c-26.51 0-48-21.49-48-48s21.49-48 48-48 48 21.49 48 48-21.49 48-48 48zm157.533 0h-34.335c-6.011 0-11.051-4.636-11.442-10.634-5.214-80.05-69.243-143.92-149.123-149.123-5.997-.39-10.633-5.431-10.633-11.441v-34.335c0-6.535 5.468-11.777 11.994-11.425 110.546 5.974 198.997 94.536 204.964 204.964.352 6.526-4.89 11.994-11.425 11.994zm103.027 0h-34.334c-6.161 0-11.175-4.882-11.427-11.038-5.598-136.535-115.204-246.161-251.76-251.76C68.882 152.949 64 147.935 64 141.774V107.44c0-6.454 5.338-11.664 11.787-11.432 167.83 6.025 302.21 141.191 308.205 308.205.232 6.449-4.978 11.787-11.432 11.787z"/></svg>
      </a>
    
  </div>

    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../../assets/javascripts/vendor.d1f5a259.min.js"></script>
      <script src="../../assets/javascripts/bundle.d5fec882.min.js"></script><script id="__lang" type="application/json">{"clipboard.copy": "Copy to clipboard", "clipboard.copied": "Copied to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.result.placeholder": "Type to start searching", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents"}</script>
      
      <script>
        app = initialize({
          base: "../..",
          features: ["tabs"],
          search: Object.assign({
            worker: "../../assets/javascripts/worker/search.fae956e7.min.js"
          }, typeof search !== "undefined" && search)
        })
      </script>
      
    
  </body>
</html>